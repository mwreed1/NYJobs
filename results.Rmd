```{r libs, include=F}
library(tidyverse)
library(redav)
library(janitor)
library(scales)
library(lubridate)
```

```{r read-data}
jobs <- read_csv("data/NYC_Jobs.csv")
```

```{r data-clean}
jobs <- jobs %>%
  clean_names() %>%
  mutate(
    category_simple = case_when(
      str_detect(job_category, "Human Resources") ~ "Human Resources",
      str_detect(job_category, "Building Operations") ~ "Building Operations",
      str_detect(job_category, "Administrative Support") ~ "Administrative Support",
      str_detect(job_category, "Communications") ~ "Communications",
      str_detect(job_category, "Constituent Services") ~ "Constituent Services",
      str_detect(job_category, "Engineering") ~ "Engineering",
      str_detect(job_category, "Finance") ~ "Finance",
      str_detect(job_category, "Health") ~ "Health",
      str_detect(job_category, "Legal") ~ "Legal",
      str_detect(job_category, "Policy") ~ "Policy, Research & Analysis",
      str_detect(job_category, "Public Safety") ~ "Public Safety",
      str_detect(job_category, "Social Services") ~ "Social Services",
      str_detect(job_category, "Technology") ~ "Technology & Data",
      TRUE ~ "Other"
    ),
    agency_simple = str_to_title(agency),
    agency_simple = case_when(
      str_detect(agency_simple, "District Attorney") ~ "District Attorney",
      str_detect(agency_simple, "Community Board") ~ "Community Board",
      TRUE ~ agency_simple
    ),
    posting_date = as.Date(posting_date, "%m/%d/%Y"),
    posting_updated = as.Date(posting_updated, "%m/%d/%Y"),
    level_simple = case_when(
      startsWith(level, "0") ~ "0",
      startsWith(level, "M") ~ "M",
      TRUE ~ "1"
    )
  )
```

# Results

## Data exploration

In order to explore our data, we first wanted to look at the distribution of different job postings by category.

```{r plot2}
jobs %>%
  ggplot(
    aes(
      y = fct_rev(fct_infreq(category_simple)), 
      )
    ) +
  geom_bar() +
  labs(
    x = "Number of jobs posted",
    y = "Simplified job category",
    title = "Number of jobs postings by category",
    caption = "Source: nyc.gov"
  ) +
  theme_minimal()
```

Based on this plot, engineering jobs clearly are the most prolific, with human resources and legal also being common in the NYC job board. The least common job postings by far are administrative support.


Next, we wanted to see what sort of factors impacted the salary range of a job.

```{r plot1b}
jobs %>%
  filter(salary_frequency == "Annual") %>%
  group_by(category_simple) %>%
  summarize(
    mean_starting = mean(salary_range_from),
    mean_ending = mean(salary_range_to)
    ) %>%
  ggplot(aes(y = fct_reorder(category_simple, mean_ending))) +
  geom_point(aes(x = mean_starting)) +
  geom_point(aes(x = mean_ending)) +
  geom_linerange(aes(xmin = mean_starting, xmax = mean_ending)) + 
  scale_x_continuous(labels = label_dollar()) +
  labs(
    x = "Average salary range (USD)",
    y = "Simplified job category",
    title = "Average salary range by job category",
    caption = "Source: nyc.gov"
  ) +
  theme_minimal()
```

Technology and data appeared to have the highest average salary potential at around 150k USD Administrative support had the lowest average salary potential at around 50k USD. The 'other' category had the largest salary range, which makes sense because it is a miscellaneous category with several possible job types. 

Next we looked at the salary ranges of the different posting agencies.

```{r plot3}
jobs %>%
  filter(salary_frequency == "Annual") %>%
  group_by(agency_simple) %>%
  summarize(
    mean_starting = mean(salary_range_from),
    mean_ending = mean(salary_range_to)
    ) %>%
  ggplot(aes(y = fct_reorder(agency_simple, mean_ending))) +
  geom_point(aes(x = mean_starting)) +
  geom_point(aes(x = mean_ending)) +
  geom_linerange(aes(xmin = mean_starting, xmax = mean_ending)) + 
  scale_x_continuous(labels = label_dollar()) +
  labs(
    x = "Average salary range (USD)",
    y = "Posting Agency",
    title = "Average salary range by posting agency",
    caption = "Source: nyc.gov"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 5)
  )
```

The Municipal Water Fin Authority posted jobs with the highest average salary potential, at around 140k USD. The Business Integrity Commission posted jobs with the lowest average salary potential, around 55k USD.


Next we looked into how a job's career level impacted its salary.

```{r}
jobs %>%
  filter(salary_frequency == "Annual", career_level != "NA") %>%
  group_by(career_level) %>%
  summarize(
    mean_starting = mean(salary_range_from),
    mean_ending = mean(salary_range_to),
    .groups = "drop"
    ) %>%
  ggplot(aes(y = fct_reorder(career_level, mean_ending))) +
  geom_point(aes(x = mean_starting)) +
  geom_point(aes(x = mean_ending)) +
  geom_linerange(aes(xmin = mean_starting, xmax = mean_ending)) + 
  scale_x_continuous(labels = label_dollar()) +
  scale_x_continuous(labels = label_dollar()) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    x = "Average salary range (USD)",
    y = "Career level",
    title = "Average salary range by career level",
    caption = "Source: nyc.gov"
  ) +
  theme_minimal()
```
The data shows that executives make the most on average and entry-level positions make the least. This trend makes sense with what we know about career levels. 


Next we looked into how a job's level impacted its salary. We split the level into three categories based on the code given to the level.

```{r}
jobs %>%
  filter(salary_frequency == "Annual") %>%
  group_by(level, level_simple) %>%
  summarize(
    mean_starting = mean(salary_range_from),
    mean_ending = mean(salary_range_to),
    .groups = "drop"
    ) %>%
  ggplot(aes(y = level, color = level_simple)) +
  geom_point(aes(x = mean_starting)) +
  geom_point(aes(x = mean_ending)) +
  geom_linerange(aes(xmin = mean_starting, xmax = mean_ending)) + 
  scale_x_continuous(labels = label_dollar()) +
  scale_x_continuous(labels = label_dollar()) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    x = "Average salary range (USD)",
    y = "Simplified job level",
    title = "Average salary range by job level",
    caption = "Source: nyc.gov"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none"
  )
```

The levels that started with M had the highest average salary potentials, while the levels that started with numbers tended to be associated with lower average salary potentials. The level with the highest average salary potential is MY. In fact, the lower end of the salary range is higher than the higher end of any other level's average salary range. 

After looking at the different factors that influenced salary range, we wanted to see if the salaries of jobs posted changed over time. In order to do so, we only looked at the lower end of the salary ranges for each job posted in our data set. 

```{r}
jobs %>%
  filter(
    salary_frequency == "Annual", 
    salary_range_from != 0, 
    year(posting_date) < 2022,
    year(posting_date) >= 2014
    ) %>%
  ggplot(aes(x = posting_date, y = salary_range_from)) +
  geom_point(alpha = 0.5) +
  geom_smooth(se=F) +
  scale_y_continuous(labels = label_dollar()) +
  labs(
    x = "Date",
    y = "Starting salary",
    title = "Starting salary over time",
    caption = "Source: nyc.gov"
  ) +
  theme_minimal()
```

```{r}
jobs %>%
  filter(
    salary_frequency == "Annual", 
    salary_range_from != 0, 
    year(posting_date) >= 2022
    ) %>%
  ggplot(aes(x = posting_date, y = salary_range_from)) +
  geom_point(alpha = 0.5) +
  geom_smooth(se=F) +
  scale_y_continuous(labels = label_dollar()) +
  labs(
    x = "Date",
    y = "Starting salary",
    title = "Starting salary over time",
    subtitle = "During 2022",
    caption = "Source: nyc.gov"
  ) +
  theme_minimal()
```


While there does not appear to be a huge change over time, job salaries seemed to peak around 2021. When focusing on 2022, it seems as though salaries peaked around August.


```{r}
jobs %>%
  arrange(desc(salary_range_to))
```




